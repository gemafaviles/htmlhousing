{
  "hash": "d2a179056b86d3bcfeed26ab3caacb7f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Trabajando con datos reales: seguimiento\"\nauthor: \"Gema Fernández-Avilés Calderón\"\n# format: html\nengine: knitr  \nformat: live-html\nwebr:\n  packages:\n    - readxl          # Para leer los datos en Excle\n    - tidyverse       # Para manipular los datos\n    - DT              # Para mostrar tablas interactivas\n#    - gganimate       # Para crear animaciones\n    - leaflet         # Para crear mapas interactivos\n    - leaflet.extras  # Para crear extesiones en mapas interactivos\n    - htmltools       # Para trabajar con HTML \n    - sf              # Para trabajar con datos espaciales\n    - mapSpain        # Para crear mapas de España\nresources:\n    - datos\nembed-resources: true \ntheme: cerulean\nhighlight-style: ayu-mirage\nself-contained: true\ndate: \"2025-11-17\"\ncode-link: true\nnumber-sections: true\nexecute:\n  code-overflow: scroll\n  echo: true\n  eval: true\n  output: true\n  include: true\n  freeze: auto\n  fig-height: 5\n  warning: false\n  code-fold: true\n  comment: \"#>\"\n  code-line-numbers: true\n  code-copy: true\n#bibliography: biblio.bib\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n\n<!-- Poner esto en la terminal para que funcione el quarto-live -->\n<!-- Tools->Terminal->Move Focus to Terminal -->\n<!-- quarto add r-wasm/quarto-live -->\n\n\n\n\n\n\n::: {.cell}\n```{webr}\nlibrary(readxl)          # Para leer los datos en Excel\nlibrary(tidyverse)       # Para manipular los datos\nlibrary(DT)              # Para mostrar tablas interactivas\nlibrary(gganimate)       # Para crear animaciones\nlibrary(leaflet)         # Para crear mapas interactivos\nlibrary(leaflet.extras)  # Para crear extesiones en mapas interactivos\nlibrary(htmltools)       # Para trabajar con HTML \nlibrary(sf)              # Para trabajar con datos espaciales\nlibrary(mapSpain)        # Para crear mapas de España\n```\n:::\n\n\n\n\n# Leo el fichero de datos y muestro las primeras filas.\n\n\n\n::: {.cell}\n```{webr}\nseguimiento <- read_excel(\"datos/PositionReport.xlsx\")\n\ndim(seguimiento)\nnames(seguimiento)\n```\n:::\n\n\n\n\n# Examino de forma interactiva el conjunto comleto.\n\n\n\n::: {.cell}\n```{webr}\nDT::datatable(seguimiento, options = list(\n  pageLength = 7\n))\n```\n:::\n\n\n\n\n# Seleccionamos una muestra (`NO es una m.a.s`), son las 500 primeras observaciones.\n\n\n\n::: {.cell}\n```{webr}\ndata500 <- seguimiento[1:500,]\n```\n:::\n\n\n\n\n\n# ¿Cómo es la trayectoria de la baliza en estas 500 observaciones?\n\n\n\n::: {.cell}\n```{webr}\nleaflet() |>\n  addTiles() |>\n  addPolylines(data = data500, lng = ~longitud, lat = ~latitud, color = \"black\", weight = 2)\n```\n:::\n\n\n\n\n# ¿Dónde ha pasado más tiempo la baliza en estas 500 observaciones?\n\n\n\n::: {.cell}\n```{webr}\nleaflet() |>\n  addTiles() |>\n    addCircleMarkers(data = data500, lng = ~longitud, lat = ~latitud, radius = 10, stroke = FALSE)\n```\n:::\n\n\n\n\n# Unimos las dos capas anteriores en un solo mapa y analizamos el resultado.\n\n\n\n::: {.cell}\n```{webr}\nmapa <- leaflet(data500) |>\n  addTiles() |>\n  addCircleMarkers(data = data500, lng = ~longitud, lat = ~latitud, radius = 8, stroke = FALSE) |>\n  addPolylines(~longitud, ~latitud, color = \"black\", weight = 3, opacity = 0.5)\n\nmapa\n```\n:::\n\n\n\n\n# ¿Dónde se inicia el recorrido? ¿En Madrid? ¿Barcelona? ¿Tarragona? ¿Zaragoza? ¿Otra ciudad?\n\n\n\n::: {.cell}\n```{webr}\npal <- colorNumeric(palette = \"viridis\", domain = data500$orden)\n\n# Crear un mapa interactivo con leaflet\nmapa <- leaflet(data500) |>\n  addTiles() |>\n  addCircleMarkers(~longitud, ~latitud, popup = ~paste(\"Fecha:\", fecha, \"<br>Velocidad:\", orden, \"Fecha\"),\n                   color = ~pal(orden), radius = 5, stroke = FALSE, fillOpacity = 0.8) |>\n    addLegend(\"bottomright\", pal = pal, values = ~orden, title = \"Time\",\n            opacity = 1)\n\nmapa\n```\n:::\n\n\n\n\n# ¿Se puede determinar en qué áreas la localización de la baliza es mayor?\n\n\n\n::: {.cell}\n```{webr}\n# Crear una paleta de colores para el orden\npal <- colorNumeric(palette = \"viridis\", domain = seguimiento$orden)\n\n# Crear un mapa interactivo con leaflet y añadir un mapa de calor\nmapa <- leaflet(data500) |>\n  addTiles() |>\n  addHeatmap(lng = ~longitud, lat = ~latitud, intensity = ~orden, blur = 20, max = 0.05, radius = 15) |>\n  addCircleMarkers(~longitud, ~latitud, popup = ~paste(\"Fecha:\", fecha),\n                   color = ~pal(orden), radius = 5, stroke = FALSE, fillOpacity = 0.8) |>\n  addLegend(\"bottomright\", pal = pal, values = ~orden, title = \"Time\",\n            opacity = 1)\n\nmapa\n```\n:::\n\n::: {.cell}\n```{webr}\n# Obtener los datos geoespaciales de España\nesp <- esp_get_country()\n\n# Extraer los bordes de España como puntos XY\nesp_borde <- st_cast(esp, \"POINT\")\n\n# Crear el gráfico con los puntos del borde de España\np <- ggplot(data500, aes(x = longitud, y = latitud, color = orden)) +\n  geom_point(data = esp_borde, aes(x = st_coordinates(esp_borde)[,1], y = st_coordinates(esp_borde)[,2]), color = \"blue\", size = 1) +\n  geom_point(size = 3) +\n    geom_line(size = 1, alpha = 0.5) +\n  geom_path(aes(group = 1), color = \"red\", size = 1, alpha = 0.5) +\n  scale_color_viridis_c() +\n  labs(title = 'Movimiento de la baliza: {frame_time}', x = 'Longitud', y = 'Latitud') +\n  theme_minimal()\n\np\n```\n:::\n\n::: {.cell}\n```{webr}\n#| eval: false\n\n# Añadir la animación con gganimate\nanim <- p +\n  transition_time(fecha) +\n  ease_aes('linear')\n\n# Guardar la animación como un archivo GIF\nanim_save(\"animacion_baliza_line.gif\", anim)\n\n# Mostrar la animación\nanim\n```\n:::\n\n\n\n\n# ¿Qué día ha tenido más conexiones la baliza?\n\n\n\n::: {.cell}\n```{webr}\nseguimiento <- seguimiento %>%\n  mutate(fecha = as.Date(fecha))\n\n# Contar el número de conexiones por día\nconexiones_por_dia <- seguimiento %>%\n  group_by(fecha) %>%\n  summarise(conexiones = n())\n\n# Encontrar el día con el mayor número de conexiones\ndia_max_conexiones <- conexiones_por_dia %>%\n  filter(conexiones == max(conexiones))\n\n# Obtener la fecha con el mayor número de conexiones\nmax_fecha <- dia_max_conexiones$fecha\n\n# Filtrar los datos para el día con el mayor número de conexiones\ndatos_max_fecha <- seguimiento %>%\n  filter(fecha == max_fecha)\n\n# Encontrar la zona con el mayor número de conexiones en ese día\nzona_max_conexiones <- datos_max_fecha %>%\n  group_by(latitud, longitud) %>%\n  summarise(conexiones = n()) %>%\n  arrange(desc(conexiones)) %>%\n  slice(1)\n\n# Mostrar la zona con el mayor número de conexiones\nprint(zona_max_conexiones)\n\n# Crear el gráfico\np <- ggplot(datos_max_fecha, aes(x = longitud, y = latitud)) +\n # geom_point(aes(color = orden), size = 3) +\n  geom_point(data = zona_max_conexiones, aes(x = longitud, y = latitud), color = \"red\", size = 3) +\n  labs(title = paste('Zona con el Mayor Número de Conexiones el Día', max_fecha),\n       x = 'Longitud', y = 'Latitud') +\n  theme_minimal()\n\np\n```\n:::\n\n\n\n\n# ¿Cuál ha sido el recorrdido de la baliza en el periodo completo?\n\n\n\n::: {.cell}\n```{webr}\n# Extraer mes y año para agrupar\nseguimiento <- seguimiento |>\n  mutate(month_year = format(fecha, \"%Y-%m\"))\n\n# Crear el gráfico\nggplot(data = esp) +\n  geom_sf() +\n  geom_point(data = seguimiento, aes(x = longitud, y = latitud, color = month_year), size = 3) +\n  labs(title = \"Movimiento de la baliza por meses\",\n       x = \"Longitud\",\n       y = \"Latitud\",\n       color = \"Mes-Año\") +\n  theme_minimal()\n```\n:::\n\n::: {.cell}\n```{webr}\n# Filtrar registros de julio\nseguimiento_julio <- seguimiento |>\n  filter(format(fecha, \"%m\") == \"07\")\n\n# Filtrar registros de agosto\nseguimiento_agosto <- seguimiento |>\n  filter(format(fecha, \"%m\") == \"08\")\n\n# Filtrar registros de septiembre\nseguimiento_septiembre <- seguimiento |>\n  filter(format(fecha, \"%m\") == \"09\")\n\n# Filtrar registros de octubre\nseguimiento_octubre <- seguimiento |>\n  filter(format(fecha, \"%m\") == \"10\")\n\n\n# Crear el mapa para julio\nmapa_julio <- leaflet(data = seguimiento_julio) |>\n  addTiles() |>\n  addCircleMarkers(~longitud, ~latitud, color = \"red\", radius = 5, fillOpacity = 0.7) |>\n  setView(lng = mean(seguimiento_julio$longitud), lat = mean(seguimiento_julio$latitud), zoom = 12) |>\n  addLegend(\"bottomright\", colors = \"red\", labels = \"Julio\", title = \"Mes\")\n\n# Crear el mapa para agosto\nmapa_agosto <- leaflet(data = seguimiento_agosto) |>\n  addTiles() |>\n  addCircleMarkers(~longitud, ~latitud, color = \"blue\", radius = 5, fillOpacity = 0.7) |>\n  setView(lng = mean(seguimiento_agosto$longitud), lat = mean(seguimiento_agosto$latitud), zoom = 12) |>\n  addLegend(\"bottomright\", colors = \"blue\", labels = \"Agosto\", title = \"Mes\")\n\n# Crear el mapa para septiembre\nmapa_septiembre <- leaflet(data = seguimiento_septiembre) |>\n  addTiles() |>\n  addCircleMarkers(~longitud, ~latitud, color = \"green\", radius = 5, fillOpacity = 0.7) |>\n  setView(lng = mean(seguimiento_septiembre$longitud), lat = mean(seguimiento_septiembre$latitud), zoom = 6) |>\n  addLegend(\"bottomright\", colors = \"green\", labels = \"Septiembre\", title = \"Mes\")\n\n# Crear el mapa para octubre\nmapa_octubre <- leaflet(data = seguimiento_octubre) |>\n  addTiles() |>\n  addCircleMarkers(~longitud, ~latitud, color = \"yellow\", radius = 5, fillOpacity = 0.7) |>\n  setView(lng = mean(seguimiento_octubre$longitud), lat = mean(seguimiento_octubre$latitud), zoom = 6) |>\n  addLegend(\"bottomright\", colors = \"yellow\", labels = \"Octubre\", title = \"Mes\")\n\n\n# Mostrar los mapas\nmapa_julio\nmapa_agosto\nmapa_septiembre\nmapa_octubre\n\n# Mostrar los mapas leaflef en un panel 2 x 2\n```\n:::\n\n\n\n# Organizamos los mapas en un panel 2 x 2\n\n\n\n\n::: {.cell}\n```{webr}\n# Organizar los mapas en una vista por columnas o paneles\nhtmltools::browsable(\n  htmltools::tagList(\n    htmltools::tags$div(style = \"display: flex; flex-wrap: wrap;\",\n      htmltools::tags$div(style = \"flex: 1; min-width: 300px;\", mapa_julio),\n      htmltools::tags$div(style = \"flex: 1; min-width: 300px;\", mapa_agosto),\n      htmltools::tags$div(style = \"flex: 1; min-width: 300px;\", mapa_septiembre),\n      htmltools::tags$div(style = \"flex: 1; min-width: 300px;\", mapa_octubre)\n    )\n  )\n)\n\n```\n:::\n\n\n\n\n# ¿Dónde ha pernoctado la baliza durante la noche?\n\n\n\n::: {.cell}\n```{webr}\n# Filtrar registros desde las 02:00 hasta las 06:00\nseguimiento_noche <- seguimiento |>\n  filter(format(fecha, \"%H:%M:%S\") >= \"02:00:00\" & format(fecha, \"%H:%M:%S\") < \"06:00:00\")\n\n# Crear un mapa leaflet con seguimiento noche para ver don de pernocta la baliza\nmapa_noche <- leaflet(data = seguimiento_noche) |>\n  addTiles() |>\n  addCircleMarkers(~longitud, ~latitud, color = \"red\", radius = 5, fillOpacity = 0.7) |>\n  setView(lng = mean(seguimiento_noche$longitud), lat = mean(seguimiento_noche$latitud), zoom = 6) |>\n  addLegend(\"bottomright\", colors = \"red\", labels = \"Noche\", title = \"Hora\")\n\n# Mostrar el mapa\nmapa_noche\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}